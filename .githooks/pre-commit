#!/usr/bin/env bash
set -euo pipefail

# Collect staged Python files
mapfile -t files < <(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.py$' || true)
if [ ${#files[@]} -eq 0 ]; then
  exit 0
fi

echo "pre-commit: running mypy on staged Python files..."

run_mypy() {
  # Prefer uv if available to use project env
  if command -v uv >/dev/null 2>&1; then
    uv run mypy "${files[@]}"
    return $?
  fi
  # Fallback to system mypy
  if command -v mypy >/dev/null 2>&1; then
    mypy "${files[@]}"
    return $?
  fi
  # Final fallback: python -m mypy
  python -c "import sys; import importlib.util; sys.exit(0 if importlib.util.find_spec('mypy') else 1)" \
    && python -m mypy "${files[@]}" && return 0

  echo "pre-commit: mypy not found. Install via 'uv add --dev mypy' or 'pip install mypy'." >&2
  return 127
}

if ! run_mypy; then
  echo "pre-commit: mypy failed. Fix type errors or commit with --no-verify if necessary." >&2
  exit 1
fi

exit 0

